#!/bin/bash
# ================================================================
# context-monitor.sh — Context Window Remaining Capacity Monitor
# ================================================================
# PURPOSE:
#   Monitors how much context window remains during a Claude Code
#   session. Issues graduated warnings (CAUTION → WARNING → CRITICAL
#   → EMERGENCY) so you never get killed by context exhaustion.
#
# HOW IT WORKS:
#   1. Reads Claude Code's debug log to extract actual token usage
#   2. Falls back to tool-call-count estimation when debug logs
#      are unavailable
#   3. Saves current % to /tmp/cc-context-pct (other scripts can
#      read this)
#   4. At CRITICAL/EMERGENCY, writes an evacuation template to
#      your mission file so you can hand off state before /compact
#
# TRIGGER: PostToolUse (all tools)
# MATCHER: "" (empty = every tool invocation)
#
# CONFIGURATION:
#   CC_CONTEXT_MISSION_FILE — path to your mission/state file
#     default: $HOME/mission.md
#
# THRESHOLDS (edit below to taste):
#   CAUTION   = 40%  — be mindful of consumption
#   WARNING   = 25%  — finish current task, save state
#   CRITICAL  = 20%  — run /compact immediately
#   EMERGENCY = 15%  — stop everything, evacuate
#
# BORN FROM:
#   A session that hit 3% context remaining with no warning.
#   The agent died mid-task and all in-flight work was lost.
#   Never again.
# ================================================================

STATE_FILE="/tmp/cc-context-state"
PCT_FILE="/tmp/cc-context-pct"
COUNTER_FILE="/tmp/cc-context-monitor-count"
MISSION_FILE="${CC_CONTEXT_MISSION_FILE:-$HOME/mission.md}"

# Tool invocation counter (fallback estimator)
COUNT=$(cat "$COUNTER_FILE" 2>/dev/null || echo 0)
COUNT=$((COUNT + 1))
echo "$COUNT" > "$COUNTER_FILE"

# Check every 3rd invocation to reduce overhead
# (but always check in CRITICAL/EMERGENCY state)
LAST_STATE=$(cat "$STATE_FILE" 2>/dev/null || echo "normal")
if [ $((COUNT % 3)) -ne 0 ] && [ "$LAST_STATE" != "critical" ] && [ "$LAST_STATE" != "emergency" ]; then
    exit 0
fi

# --- Extract context % from Claude Code debug logs ---
get_context_pct() {
    local debug_dir="$HOME/.claude/debug"
    if [ ! -d "$debug_dir" ]; then
        echo ""
        return
    fi

    local latest
    latest=$(find "$debug_dir" -maxdepth 1 -name '*.txt' -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2)
    if [ -z "$latest" ]; then
        echo ""
        return
    fi

    # Parse the last autocompact entry for token counts
    local line
    line=$(grep 'autocompact:' "$latest" 2>/dev/null | tail -1)
    if [ -z "$line" ]; then
        echo ""
        return
    fi

    local tokens window
    tokens=$(echo "$line" | sed 's/.*tokens=\([0-9]*\).*/\1/')
    window=$(echo "$line" | sed 's/.*effectiveWindow=\([0-9]*\).*/\1/')

    if [ -n "$tokens" ] && [ -n "$window" ] && [ "$window" -gt 0 ] 2>/dev/null; then
        local pct
        pct=$(( (window - tokens) * 100 / window ))
        echo "$pct"
    else
        echo ""
    fi
}

CONTEXT_PCT=$(get_context_pct)

# Fallback: estimate from tool call count when debug logs unavailable
# Assumes ~180 tool calls fills ~100% of context (conservative)
if [ -z "$CONTEXT_PCT" ]; then
    CONTEXT_PCT=$(( 100 - (COUNT * 100 / 180) ))
    if [ "$CONTEXT_PCT" -lt 0 ]; then CONTEXT_PCT=0; fi
    SOURCE="estimate"
else
    SOURCE="debug"
fi

echo "$CONTEXT_PCT" > "$PCT_FILE"

TIMESTAMP=$(date '+%Y-%m-%d %H:%M')

# --- Evacuation template (with cooldown to prevent spam) ---
EVAC_COOLDOWN_FILE="/tmp/cc-context-evac-last"
EVAC_COOLDOWN_SEC=1800  # 30 min cooldown between template generations

generate_evacuation_template() {
    local level="$1"

    # Cooldown check
    if [ -f "$EVAC_COOLDOWN_FILE" ]; then
        local last_ts now_ts diff
        last_ts=$(cat "$EVAC_COOLDOWN_FILE" 2>/dev/null || echo 0)
        now_ts=$(date +%s)
        diff=$((now_ts - last_ts))
        if [ "$diff" -lt "$EVAC_COOLDOWN_SEC" ]; then
            return
        fi
    fi

    # Don't add a new template if there's already an unfilled one
    if [ -f "$MISSION_FILE" ] && grep -q '\[TODO\]' "$MISSION_FILE" 2>/dev/null; then
        return
    fi

    date +%s > "$EVAC_COOLDOWN_FILE"

    # Create mission file directory if needed
    mkdir -p "$(dirname "$MISSION_FILE")"

    cat >> "$MISSION_FILE" << EVAC_EOF

## Context Evacuation Template (${level} - ${TIMESTAMP})
<!-- Auto-generated by context-monitor.sh. Fill in before /compact -->
### Current Task
- Task: [TODO]
- Progress: [TODO]
- Files being edited: [TODO]

### Git State
- Branch: [TODO]
- Uncommitted changes: [TODO]

### Next Action
- Next command/action: [TODO]
EVAC_EOF
}

# --- Graduated warnings ---
if [ "$CONTEXT_PCT" -le 15 ]; then
    # EMERGENCY
    if [ "$LAST_STATE" != "emergency" ]; then
        echo "emergency" > "$STATE_FILE"
        generate_evacuation_template "EMERGENCY"
    fi
    echo ""
    echo "EMERGENCY: Context remaining ${CONTEXT_PCT}% (${SOURCE})"
    echo "Run /compact IMMEDIATELY. Evacuation template written to ${MISSION_FILE}."
    echo "1. Fill in the [TODO] fields in the template"
    echo "2. Run /compact"
    echo "3. If needed, restart and resume from mission file"
    echo "No further work allowed. Evacuate only."

elif [ "$CONTEXT_PCT" -le 20 ]; then
    # CRITICAL
    if [ "$LAST_STATE" != "critical" ]; then
        echo "critical" > "$STATE_FILE"
        generate_evacuation_template "CRITICAL"
    fi
    echo ""
    echo "CRITICAL: Context remaining ${CONTEXT_PCT}% (${SOURCE})"
    echo "Run /compact IMMEDIATELY. Evacuation template written to ${MISSION_FILE}."
    echo "1. Save current task state to the template"
    echo "2. Run /compact"

elif [ "$CONTEXT_PCT" -le 25 ]; then
    # WARNING
    if [ "$LAST_STATE" != "warning" ]; then
        echo "warning" > "$STATE_FILE"
        echo ""
        echo "WARNING: Context remaining ${CONTEXT_PCT}% (${SOURCE})"
        echo "Do not start new large tasks. Finish current work and save state."
    fi

elif [ "$CONTEXT_PCT" -le 40 ]; then
    # CAUTION
    if [ "$LAST_STATE" != "caution" ]; then
        echo "caution" > "$STATE_FILE"
        echo ""
        echo "CAUTION: Context remaining ${CONTEXT_PCT}% (${SOURCE})"
        echo "Be mindful of context consumption. Keep interactions concise."
    fi
fi

exit 0
